<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Raport frecvență elevi</title>

<!-- Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f5f7fb;color:#222;margin:0;padding:20px;}
  .container{max-width:1200px;margin:auto;}
  h1{margin:0 0 8px;font-size:34px;}
  .subtitle{color:#555;margin-bottom:16px;}
  .card{background:#fff;border:1px solid #ddd;border-radius:10px;padding:16px;margin-bottom:18px;}
  .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;}
  label{display:block;font-size:13px;color:#555;margin-bottom:6px;}
  input{width:100%;padding:10px;border:1px solid #cfcfcf;border-radius:8px;font-size:14px;outline:none;}
  input:focus{border-color:#7aa7ff;}
  .summary{display:flex;gap:14px;flex-wrap:wrap;margin-top:12px;align-items:center;}
  .box{padding:10px 14px;background:#f0f3f9;border-radius:8px;}
  button{padding:10px 14px;border:1px solid #ccc;background:#fff;border-radius:8px;cursor:pointer;font-weight:700;}
  button:hover{background:#f2f2f2;}
  table{width:100%;border-collapse:collapse;background:#fff;}
  th,td{border:1px solid #ccc;padding:8px;font-size:13px;}
  th{background:#eef2f7;}
  td.num{text-align:right;}
  td.center{text-align:center;}
  td input{width:110px;}
  .red{border-color:red !important;}
  .note{font-size:12px;color:#666;margin-top:10px;}
</style>
</head>

<body>
<div class="container">
  <h1>Raport cu privire la frecvența elevilor</h1>
  <div class="subtitle"></div>

  <div class="card">
    <div class="grid">
      <div>
        <label>Clasa</label>
        <input id="clasa" value="7E" />
      </div>
      <div>
        <label>Nr. elevi</label>
        <input id="nrElevi" type="number" min="0" step="1" value="21" />
      </div>
      <div>
        <label>Ore / săptămână</label>
        <input id="oreSapt" type="number" min="0" step="1" value="30" />
      </div>
      <div>
        <label>Nr. săptămâni</label>
        <input id="nrSapt" type="number" min="0" step="1" value="15" />
      </div>
      <div>
        <label>Ore suplimentare (total)</label>
        <input id="oreSupl" type="number" min="0" step="1" value="19" />
      </div>
    </div>

    <div class="summary">
      <div class="box">Ore per elev: <b id="perElev">0</b></div>
      <div class="box">Total ore clasă: <b id="totalClasa">0</b></div>
      <div class="box">Formula: <b id="formula">—</b></div>

      <button id="btnExcel">Export Excel</button>
      <button id="btnWord">Export Word</button>
      <button id="btnReset">Reset</button>
    </div>

    <div class="note">
      Formula: <b>ore/săptămână × săptămâni + ore suplimentare</b> (ex: 30×15 + 19 = 469).<br>
      În tabel, „Nr. ore ce trebuiau frecventate” este pentru CLASĂ: <b>(ore per elev) × (nr. elevi)</b>.
    </div>
  </div>

  <div class="card">
    <table id="tabel">
      <thead>
        <tr>
          <th>Semestrul</th>
          <th>Nr. elevi</th>
          <th>Nr. ore ce trebuiau frecventate</th>
          <th>Ore lipsă (total)</th>
          <th>Frecvența %</th>
          <th>Ore lipsă / elev</th>
          <th>Boală</th><th>%</th>
          <th>Motivate</th><th>%</th>
          <th>Nemotivate</th><th>%</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>

    <div class="note">
      Validare: dacă <b>boală + motivate + nemotivate</b> depășește <b>total lipsă</b>, câmpurile devin roșii.
    </div>
  </div>
</div>

<script>
  const randuri = ["I","II","anual","școlarizare","abandon"];

  const $ = (id) => document.getElementById(id);

  const el = {
    clasa: $("clasa"),
    nrElevi: $("nrElevi"),
    oreSapt: $("oreSapt"),
    nrSapt: $("nrSapt"),
    oreSupl: $("oreSupl"),
    perElev: $("perElev"),
    totalClasa: $("totalClasa"),
    formula: $("formula"),
    tbody: $("tbody"),
    btnExcel: $("btnExcel"),
    btnWord: $("btnWord"),
    btnReset: $("btnReset")
  };

  const num = (v) => {
    const x = Number(v);
    return Number.isFinite(x) ? x : 0;
  };

  // Rotunjire stabilă la 2 zecimale
  const round2 = (x) => Math.round((x + Number.EPSILON) * 100) / 100;
  const f2 = (x) => round2(x).toFixed(2);

  function calculeaza(){
    const ne = num(el.nrElevi.value);
    const os = num(el.oreSapt.value);
    const ns = num(el.nrSapt.value);
    const supl = num(el.oreSupl.value);

    const per = os * ns + supl;     // per elev (ex: 469)
    const total = per * ne;         // total clasă (ex: 9849)

    el.perElev.textContent = per;
    el.totalClasa.textContent = total;
    el.formula.textContent = `${os}×${ns} + ${supl} = ${per}`;

    return { per, total, ne };
  }

  // Recalculează un rând (automat la orice input)
  function recalc(tr, c){
    const ne = Math.max(0, c.ne);
    const totalClasa = Math.max(0, c.total);

    // actualizează mereu aceste 2 celule (ca să nu rămână 21 fix)
    tr.children[1].textContent = ne;
    tr.children[2].textContent = totalClasa;

    const lipsa = Math.max(0, num(tr.querySelector('[data-in="lipsa"]').value));
    const boala = Math.max(0, num(tr.querySelector('[data-in="boala"]').value));
    const motiv = Math.max(0, num(tr.querySelector('[data-in="motiv"]').value));
    const nemotiv = Math.max(0, num(tr.querySelector('[data-in="nemotiv"]').value));

    // frecvență % raportată la totalul CLASEI
    const frecv = totalClasa > 0 ? ((totalClasa - lipsa) / totalClasa) * 100 : 0;
    tr.querySelector('[data-out="frecv"]').textContent = f2(Math.max(0, Math.min(100, frecv)));

    // ore lipsă / elev
    const lipsaElev = ne > 0 ? (lipsa / ne) : 0;
    tr.querySelector('[data-out="lipsaElev"]').textContent = f2(lipsaElev);

    // procente din total lipsă
    const boalaPct = lipsa > 0 ? (boala / lipsa) * 100 : 0;
    const motivPct = lipsa > 0 ? (motiv / lipsa) * 100 : 0;
    const nemotivPct = lipsa > 0 ? (nemotiv / lipsa) * 100 : 0;

    tr.querySelector('[data-out="boalaPct"]').textContent = f2(boalaPct);
    tr.querySelector('[data-out="motivPct"]').textContent = f2(motivPct);
    tr.querySelector('[data-out="nemotivPct"]').textContent = f2(nemotivPct);

    // validare (sum > lipsa)
    const sum = boala + motiv + nemotiv;
    const iBoala = tr.querySelector('[data-in="boala"]');
    const iMotiv = tr.querySelector('[data-in="motiv"]');
    const iNem = tr.querySelector('[data-in="nemotiv"]');

    [iBoala,iMotiv,iNem].forEach(i => i.classList.remove("red"));
    if(sum > lipsa){
      [iBoala,iMotiv,iNem].forEach(i => i.classList.add("red"));
    }
  }

  // Recalculează TOT tabelul (automat)
  function recalcAll(){
    const c = calculeaza();
    el.tbody.querySelectorAll("tr").forEach(tr => recalc(tr, c));
  }

  // Construiește tabelul păstrând valorile introduse
  function construieste(){
    const c = calculeaza();

    // păstrează valorile vechi (ca să nu se șteargă)
    const old = {};
    el.tbody.querySelectorAll("tr").forEach(tr => {
      const sem = tr.children[0].textContent.trim();
      old[sem] = {
        lipsa: tr.querySelector('[data-in="lipsa"]').value,
        boala: tr.querySelector('[data-in="boala"]').value,
        motiv: tr.querySelector('[data-in="motiv"]').value,
        nemotiv: tr.querySelector('[data-in="nemotiv"]').value
      };
    });

    el.tbody.innerHTML = "";

    randuri.forEach(sem => {
      const keep = old[sem] || {lipsa:0, boala:0, motiv:0, nemotiv:0};

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${sem}</td>
        <td class="num">${c.ne}</td>
        <td class="num">${c.total}</td>

        <td class="center">
          <input type="number" min="0" step="1" value="${keep.lipsa}" data-in="lipsa">
        </td>

        <td class="num" data-out="frecv">0.00</td>
        <td class="num" data-out="lipsaElev">0.00</td>

        <td class="center">
          <input type="number" min="0" step="1" value="${keep.boala}" data-in="boala">
        </td>
        <td class="num" data-out="boalaPct">0.00</td>

        <td class="center">
          <input type="number" min="0" step="1" value="${keep.motiv}" data-in="motiv">
        </td>
        <td class="num" data-out="motivPct">0.00</td>

        <td class="center">
          <input type="number" min="0" step="1" value="${keep.nemotiv}" data-in="nemotiv">
        </td>
        <td class="num" data-out="nemotivPct">0.00</td>
      `;

      // auto-recalc la orice input din rând
      tr.querySelectorAll("input").forEach(inp => {
        inp.addEventListener("input", recalcAll);
      });

      el.tbody.appendChild(tr);
    });

    // recalc imediat după construire
    recalcAll();
  }

  // Export Excel corect (citește valori din INPUT-uri)
  function exportExcel(){
    recalcAll();

    const aoa = [
      ["Semestrul","Nr. elevi","Nr. ore ce trebuiau frecventate","Ore lipsă (total)","Frecvența %","Ore lipsă / elev",
       "Boală (ore)","Boală (%)","Motivate (ore)","Motivate (%)","Nemotivate (ore)","Nemotivate (%)"]
    ];

    el.tbody.querySelectorAll("tr").forEach(tr => {
      aoa.push([
        tr.children[0].textContent.trim(),
        tr.children[1].textContent.trim(),
        tr.children[2].textContent.trim(),
        tr.querySelector('[data-in="lipsa"]').value,
        tr.querySelector('[data-out="frecv"]').textContent.trim(),
        tr.querySelector('[data-out="lipsaElev"]').textContent.trim(),
        tr.querySelector('[data-in="boala"]').value,
        tr.querySelector('[data-out="boalaPct"]').textContent.trim(),
        tr.querySelector('[data-in="motiv"]').value,
        tr.querySelector('[data-out="motivPct"]').textContent.trim(),
        tr.querySelector('[data-in="nemotiv"]').value,
        tr.querySelector('[data-out="nemotivPct"]').textContent.trim(),
      ]);
    });

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(aoa), "Raport");

    const c = calculeaza();
    const meta = [
      ["Clasa", el.clasa.value],
      ["Nr. elevi", c.ne],
      ["Ore / săptămână", num(el.oreSapt.value)],
      ["Nr. săptămâni", num(el.nrSapt.value)],
      ["Ore suplimentare", num(el.oreSupl.value)],
      ["Ore per elev", c.per],
      ["Total ore clasă", c.total]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(meta), "Parametri");

    XLSX.writeFile(wb, `raport_frecventa_${(el.clasa.value||"clasa").trim()}.xlsx`);
  }

  // Export Word (tabel curat, fără input-uri)
  function exportWord(){
    recalcAll();

    const c = calculeaza();
    const esc = s => String(s ?? "").replace(/[&<>"]/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[ch]));

    let rowsHtml = "";
    el.tbody.querySelectorAll("tr").forEach(tr => {
      rowsHtml += `
        <tr>
          <td>${esc(tr.children[0].textContent.trim())}</td>
          <td style="text-align:right;">${esc(tr.children[1].textContent.trim())}</td>
          <td style="text-align:right;">${esc(tr.children[2].textContent.trim())}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-in="lipsa"]').value)}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-out="frecv"]').textContent.trim())}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-out="lipsaElev"]').textContent.trim())}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-in="boala"]').value)}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-out="boalaPct"]').textContent.trim())}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-in="motiv"]').value)}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-out="motivPct"]').textContent.trim())}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-in="nemotiv"]').value)}</td>
          <td style="text-align:right;">${esc(tr.querySelector('[data-out="nemotivPct"]').textContent.trim())}</td>
        </tr>
      `;
    });

    const html = `
      <html><head><meta charset="utf-8">
      <style>
        body{font-family:"Times New Roman",serif;color:#000;}
        h2,h3{margin:0;text-align:center;}
        h3{font-weight:normal;margin-top:6px;}
        table{width:100%;border-collapse:collapse;font-size:12pt;margin-top:14px;}
        td,th{border:1px solid #000;padding:6px;}
        th{background:#eef2f7;}
        .meta{margin-top:10px;}
      </style></head><body>
        <h2>Raport</h2>
        <h3>cu privire la frecvența elevilor</h3>
        <h3>anul de studii 2024-2025</h3>
        <div class="meta">
          <p>Clasa: <b>${esc(el.clasa.value)}</b></p>
          <p>Formula: ${esc(num(el.oreSapt.value))}×${esc(num(el.nrSapt.value))} + ${esc(num(el.oreSupl.value))} = <b>${esc(c.per)}</b> (ore per elev)</p>
          <p>Total ore clasă: <b>${esc(c.total)}</b></p>
        </div>

        <table>
          <tr>
            <th>Semestrul</th><th>Nr. elevi</th><th>Ore ce trebuiau frecventate</th><th>Ore lipsă</th>
            <th>Frecvența %</th><th>Ore lipsă/elev</th>
            <th>Boală</th><th>%</th><th>Motivate</th><th>%</th><th>Nemotivate</th><th>%</th>
          </tr>
          ${rowsHtml}
        </table>

        <p style="margin-top:18px;">Diriginte: ____________________________</p>
      </body></html>
    `;

    const blob = new Blob([html], { type: "application/msword;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `raport_frecventa_${(el.clasa.value||"clasa").trim()}_2024-2025.doc`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function resetAll(){
    el.clasa.value = "7E";
    el.nrElevi.value = 21;
    el.oreSapt.value = 30;
    el.nrSapt.value = 15;
    el.oreSupl.value = 19;

    // resetează și input-urile din tabel
    construieste();
  }

  // AUTO: reconstruim tabelul când se schimbă parametrii de sus
  [el.nrElevi, el.oreSapt, el.nrSapt, el.oreSupl].forEach(inp => {
    inp.addEventListener("input", () => construieste());
  });

  // butoane
  el.btnExcel.addEventListener("click", exportExcel);
  el.btnWord.addEventListener("click", exportWord);
  el.btnReset.addEventListener("click", resetAll);

  // init
  construieste();
</script>
</body>
</html>
